ITEMBLUE_TSKID_COUNT = 553;
TASKBASE = 3200;

tbWeaponInfo = 
{
	{szName = "HuyÒn ThiÕt KiÕm",tbProp = {0,0,0,10}},
	{szName = "§¹i Phong §ao",tbProp = {0,0,1,10}},
	{szName = "Kim C« Bæng",tbProp = {0,0,2,10}},
	{szName = "Ph¸ Thiªn KÝch",tbProp = {0,0,3,10}},
	{szName = "Ph¸ Thiªn Chuú",tbProp = {0,0,4,10}},
	{szName = "Th«n NhËt Tr¶m",tbProp = {0,0,5,10}},
	{szName = "B¸ V­¬ng Tiªu",tbProp = {0,1,0,10}},
	{szName = "To¸i NguyÖt §ao",tbProp = {0,1,1,10}},
	{szName = "Khæng T­íc Linh",tbProp = {0,1,2,10}},
}

tbQuanAo = 
{
	--d©y chuyÒn: 1-2
	{zName = "Toµn Th¹ch H¹ng Liªm",		nProp = {0,4,0,10}, nLucky = 200},
	{zName = "Lôc PhØ Thóy hé th©n phï",		nProp = {0,4,1,10},nLucky = 2000 },
	--nhÉn: 3
	{zName = "Toµn Th¹ch Giíi ChØ ",		nProp = {0,3,0,10}, nLucky = 2000},
	--bao tay: 4 -5
	{zName = "Long Phông HuyÕt Ngäc Tr¹c",		nProp = {0,8,0,10},nLucky = 200 },
	{zName = "Thiªn TÇm Hé UyÓn",		nProp = {0,8,1,10},nLucky = 2000 },
	--®ai l­ng: 6-7
	{zName = "Thiªn Tµm Yªu §¸i",		nProp = {0,6,0,10} },
	{zName = "B¹ch Kim Yªu §¸i",		nProp = {0,6,1,10} },
	--giµy: 8-11
	{zName = "Cöu TiÕt X­¬ng VÜ Ngoa",		nProp = {0,5,0,10} ,nLucky = 2000},
	{zName = "Thiªn Tµm Ngoa",		nProp = {0,5,1,10},nLucky = 2000 },
	{zName = "Kim Lò hµi",		nProp = {0,5,2,10},nLucky = 2000 },
	{zName = "Phi Phông ngoa",		nProp = {0,5,3,10},nLucky = 2000 },
	--mò: 12-25
	{zName = "T× L« M·o",		nProp = {0,7,0,10} },
	{zName = "Ngò L·o Qu¸n",		nProp = {0,7,1,10} },
	{zName = "Tu La ph¸t kÕt",		nProp = {0,7,2,10} },
	{zName = "Th«ng Thiªn Ph¸t Qu¸n",		nProp = {0,7,3,10} },
	{zName = "YÓm NhËt Kh«i",		nProp = {0,7,4,10} },
	{zName = "TrÝch Tinh Hoµn",		nProp = {0,7,5,10} },
	{zName = "¤ Tµm M·o",		nProp = {0,7,6,10} },
	{zName = "Quan ©m Ph¸p Qu¸n",		nProp = {0,7,7,10} },
	{zName = "¢m D­¬ng V« Cùc Qu¸n",		nProp = {0,7,8,10} },
	{zName = "HuyÒn Tª DiÖn Tr¸o",		nProp = {0,7,9,10} },
	{zName = "Long HuyÕt §Çu Hoµn",		nProp = {0,7,10,10} },
	{zName = "Long L©n Kh«i",		nProp = {0,7,11,10} },
	{zName = "Thanh Tinh Thoa",		nProp = {0,7,12,10} },
	{zName = "Kim Phông TriÓn Si",		nProp = {0,7,13,10} },
	--ngäc béi: 26 - 27
	{zName = "Long Tiªn H­¬ng Nang", nProp = {0,9,0,10}},
	{zName = "D­¬ng Chi B¹ch Ngäc", nProp = {0,9,1,10}},
	--ao: 28-end
	{zName = "ThÊt B¶o Cµ Sa",		nProp = {0,2,0,10} },
	{zName = "Ch©n ThøcTh¸nh Y",		nProp = {0,2,1,10} },
	{zName = "Thiªn NhÉn MËt Y",		nProp = {0,2,2,10} },
	{zName = "Gi¸ng Sa bµo",		nProp = {0,2,3,10} },
	{zName = "§­êng Nghª gi¸p",		nProp = {0,2,4,10} },
	{zName = "V¹n L­u Quy T«ng Y",		nProp = {0,2,5,10} },
	{zName = "TuyÒn Long bµo",		nProp = {0,2,6,10} },
	{zName = "ThÊt B¶o cµ sa",		nProp = {0,2,7,10} },
	{zName = "Long Tiªu §¹o nh©n",		nProp = {0,2,8,10} },
	{zName = "Cöu VÜ B¹ch Hå y",		nProp = {0,2,9,10} },
	{zName = "TrÇm H­¬ng Sam",		nProp = {0,2,10,10} },
	{zName = "TÝch LÞch Kim Phong gi¸p",		nProp = {0,2,11,10} },
	{zName = "V¹n Chóng TÒ T©m Y",		nProp = {0,2,12,10} },
	{zName = "L­u Tiªn quÇn",		nProp = {0,2,13,10} },
	{zName = "ThÊt B¶o cµ sa (N÷)",		nProp = {0,2,14,10} },
	{zName = "Ch©n thøc th¸nh y",		nProp = {0,2,15,10} },
	{zName = "Thiªn NhÉn MËt y",		nProp = {0,2,16,10} },
	{zName = "Gi¸ng Sa bµo",		nProp = {0,2,17,10} },
	{zName = "§­êng Nghª gi¸p",		nProp = {0,2,18,10} },
	{zName = "V¹n L­u Quy t«ng y",		nProp = {0,2,19,10} },
	{zName = "TuyÒn Long bµo",		nProp = {0,2,20,10} },
	{zName = "ThÊt B¶o cµ sa",		nProp = {0,2,21,10} },
	{zName = "Long Tiªu §¹o nh©n",		nProp = {0,2,22,10} },
	{zName = "Cöu VÜ B¹ch Hå y",		nProp = {0,2,23,10} },
	{zName = "TrÇm H­¬ng sam",		nProp = {0,2,24,10} },
	{zName = "TÝch LÞch Kim Phong gi¸p",		nProp = {0,2,25,10} },
	{zName = "V¹n Chóng TÒ T©m y",		nProp = {0,2,26,10} },
	{zName = "L­u Tiªn quÇn",		nProp = {0,2,27,10} },
	{zName = "§Þnh Quèc Thanh Sa Tr­êng Sam",		nProp = {0,2,28,10} },
}
---------------------------lib----------------------------------------
function gTask(nTaskID,nKindTask)
	if nKindTask then 
		return GetTask(nTaskID);
	end
	
	local myTaskID = nTaskID + TASKBASE;
	return GetTask(myTaskID);
end

function sTask(nTaskID,nTaskValue,nKindTask)
	if nKindTask then 
		SetTask(nTaskID,nTaskValue);
		SyncTaskValue(nTaskID);
		return 
	end
	
	local myTaskID = nTaskID + TASKBASE;
	SetTask(myTaskID,nTaskValue);
	SyncTaskValue(myTaskID);
end

function GetRoomHanhTrang(nType,nWide,nLength)
	if nType == 0 then --check tõng « trong hµnh trang.
		if nWide and CalcFreeItemCellCount() < nWide then 
			Say("Hµnh trang kh«ng ®ñ "..nWide.." « trèng",0);
			return
		end
		return 1;
	elseif nType == 1 then --check theo khung dµi réng
		if nWide and nLength and CountFreeRoomByWH(nWide,nLength,1) < 1 then 
			Say("Hµnh trang kh«ng cã ®ñ kho¶ng trèng "..nWide.." x "..nLength.." ",0);
			return 
		end
		return 1;
	end
	
	return 1;
end

tbDarkDescribe = {}
tbDarkDescribe.nCountPerPage = 5;
tbDarkDescribe.szTitle = "";
tbDarkDescribe.szNpcName = "";
tbDarkDescribe.tbData = {}

 ---tbOpt = { {"name",function,{function,param1,param2}}}
 function tbDarkDescribe:SetNpcInfo(szTitle,tbOpt,nNewCountPerPage)
	if szTitle == "" then 
		tbDarkDescribe.szTitle = "Xin Chµo: "
	else
		tbDarkDescribe.szTitle = szTitle
	end

	if nNewCountPerPage then 
		tbDarkDescribe.nCountPerPage = nNewCountPerPage
	end

	tbDarkDescribe.tbData = tbOpt;
 end
 
--tbDarkDescribe:DialogMenu(1): call first page.
 function tbDarkDescribe:DialogMenu(nPage)
 
	local nTotalCount = getn(tbDarkDescribe.tbData)
	local nCountPerPage = tbDarkDescribe.nCountPerPage
	local nStart = (nPage - 1) * nCountPerPage + 1
	local nEnd = nStart + nCountPerPage - 1

	if nStart > nTotalCount then
		return
	end

	if nEnd > nTotalCount then
		nEnd = nTotalCount
	end

	local tbOpt = {}
	
	for i=nStart, nEnd do
		local opt = {	format("%s",tbDarkDescribe.tbData[i][1]),tbDarkDescribe.tbData[i][2],tbDarkDescribe.tbData[i][3]}
		tinsert(tbOpt, opt)
	end
	
	if nStart > 1 then
		tinsert(tbOpt, {"Quay l¹i trang tr­íc", tbDarkDescribe.DialogMenu, {tbDarkDescribe.DialogMenu, nPage - 1}})
	end
	
	if nEnd < nTotalCount then
		tinsert(tbOpt, {"Trang kÕ tiÕp", tbDarkDescribe.DialogMenu, {tbDarkDescribe.DialogMenu, nPage + 1}})
	end
	
	tinsert(tbOpt, {"KÕt thóc ®èi tho¹i"})
	CreateNewSayEx(tbDarkDescribe.szTitle, tbOpt)
end
-----------------------------------------------------------------------
function ITEMBLUE_MakeItem()
	local tb = {"<dec><npc>C¸ch thøc chuyÓn ®æi nh­ sau:\n<color=green>+ 3 viªn thuû tinh\n+ Trang bÞ xanh cÇn chuyÓn\n+ 1 viªn th¹ch chuyÓn ho¸ cïng lo¹i víi vò khÝ.<color>.<enter><enter>Ng­¬i muèn ta gióp ng­¬i chuyÓn ®æi g× nµo?"}
	tinsert(tb,"Ta muèn chuyÓn ®çi vò khÝ trang bÞ xanh/ITEMBLUE_ChangeNewForm")
	tinsert(tb,"§Ó ta suy nghÜ thªm/cancel")
	CreateTaskSay(tb)
end

function ITEMBLUE_ChangeNewForm()
	local szDec = "Nh÷ng nguyªn liÖu cÇn:\n+ 1 viªn th¹ch chuyÓn ho¸\n+ 3 viªn thuû tinh\n+ Vò khÝ xanh chuyÓn ®æi"
	GiveItemUI("ChuyÓn ®æi vò khÝ trang bÞ xanh",szDec,"ITEMBLUE_DoChangeForm","cancel",1)
end

function ITEMBLUE_DoChangeForm(nItemCount)
	if not GetRoomHanhTrang(1,2,4) then 
		return 
	end
	
	if nItemCount > 5 then 
		Say("ChØ cã thÓ bá vµo 3 viªn thuû tinh, 1 viªn th¹ch chuyÓn ho¸ vµ vò khÝ xanh cÇn chuyÓn",0)
		return 
	end

	local item_stonechange = 
	{
		["6,4380"] = {szName = "Th¹ch ChuyÓn Ho¸ (KiÕm)",tbProp = {0,0,0}},
		["6,4381"] = {szName = "Th¹ch ChuyÓn Ho¸ (§ao)",tbProp = {0,0,1}},
		["6,4382"] = {szName = "Th¹ch ChuyÓn Ho¸ (Bæng)",tbProp = {0,0,2}},
		["6,4383"] = {szName = "Th¹ch ChuyÓn Ho¸ (KÝch)",tbProp = {0,0,3}},
		["6,4384"] = {szName = "Th¹ch ChuyÓn Ho¸ (Chuú)",tbProp = {0,0,4}},
		["6,4385"] = {szName = "Th¹ch ChuyÓn Ho¸ (Song §ao)",tbProp = {0,0,5}},
		["6,4386"] = {szName = "Th¹ch ChuyÓn Ho¸ (Phi Tiªu)",tbProp = {0,1,0}},
		["6,4387"] = {szName = "Th¹ch ChuyÓn Ho¸ (Phi §ao)",tbProp = {0,1,1}},
		["6,4388"] = {szName = "Th¹ch ChuyÓn Ho¸ (Tô TiÔn)",tbProp = {0,1,2}},
		
	};
	local item_blue = 
	{
		["0,0,0"] = "KiÕm",
		["0,0,1"] = "§ao",
		["0,0,2"] = "Bæng",
		["0,0,3"] = "KÝch",
		["0,0,4"] = "Chuú",
		["0,0,5"] = "Song §ao",
		["0,1,0"] = "Phi Tiªu",
		["0,1,1"] = "Phi §ao",
		["0,1,2"] = "Tô TiÔn",
	}
	
	local itempar = {[4] = {[238] = 1,[239] = 1,[240] = 1}};
	local tbremove = {itemcrystal = {},itemstone = {},itemblue = {}};
	
	for k=1,nItemCount do 
		local itemidx = GetGiveItemUnit(k);
		local nPar,nType,nID = GetItemProp(itemidx);
		local myitemname = GetItemName(itemidx);
		--lÊy thuû tinh.
		if itempar[nPar] then 
			if itempar[nPar][nType] then 
				tinsert(tbremove.itemcrystal,itemidx)
			end
		end
		--th¹ch chuyÓn ho¸
		local stoneid = format("%d,%d",nPar,nID);
		if item_stonechange[stoneid] then 
			tinsert(tbremove.itemstone,itemidx);
		end
		
		--vò khÝ xanh
		local itemblueid = format("%d,%d,%d",nPar,nType,nID)
		if item_blue[itemblueid] then 
			tinsert(tbremove.itemblue,itemidx);
		end
	end
	
	--ktra thuû tinh 
	local count_tt = getn(tbremove.itemcrystal);
	if count_tt ~= 3  then 
		Say("B¾t buéc ng­¬i cÇn ph¶i cã 3 viªn thuû tinh kh«ng h¬n kh«ng kÐm th× míi cã thÓ chuyÓn ®æi.",0);
		return 
	end
	--ktra th¹ch chuyÓn ho¸.
	local count_stone = getn(tbremove.itemstone);
	if count_stone ~= 1 then 
		Say("ChØ cÇn 1 viªn th¹ch chuyÓn ho¸ kh«ng h¬n kh«ng kÐm ®Ó chuyÓn ®æi.",0);
		return 
	end
	
	--ktra item blue
	local count_itemblue = getn(tbremove.itemblue);
	if count_itemblue ~= 1 then 
		Say("Ph¶i cã 1 vò khÝ xanh kh«ng h¬n kh«ng kÐm ®Ó chuyÓn ®æi.",0);
		return 
	end
	
	--ktra item blue víi th¹ch chuyÓn ho¸
	--check type itemblue
	if not tbremove.itemblue[1] then 
		print("bug index",tbremove.itemblue);
		return 
	end
	
	local nGenre, nDetailType, nParticular, nLevel, nSeries, nLuck = GetItemProp(tbremove.itemblue[1]);
	local itembluename = GetItemName(tbremove.itemblue[1])
	local nRandSeed = ITEM_GetItemRandSeed(tbremove.itemblue[1]);
	local tbParam = GetItemAllParams(tbremove.itemblue[1]);
	local pPStone,pGStone,pDStone = GetItemProp(tbremove.itemstone[1]);
	local stritemblueid = format("%d,%d,%d",nGenre,nDetailType,nParticular);
	local strstoneid = format("%d,%d",pPStone,pDStone);
	local tbItemBlueProp = item_stonechange[strstoneid].tbProp;
	local strlogolditem = format("%d,%d,%d,%d,%d,%d",nGenre,nDetailType,nParticular,nLevel,nSeries,nLuck)
	for k=1,getn(tbParam) do 
		strlogolditem = strlogolditem..format(",%d",tbParam[k])
	end
	
	--AddItemEx(nItemVer, nRandseed, nQ, nG, nD, nL, nS, nLucky, nMagic0, nMagic1, nMagic2, nMagic3, nMagic4, nMagic5, nMagic6);
	--tiÕn hµnh xo¸
	for k=1,count_tt do 
		RemoveItemByIndex(tbremove.itemcrystal[k]);
	end
	
	RemoveItemByIndex(tbremove.itemblue[1]);
	RemoveItemByIndex(tbremove.itemstone[1]);
	local itemnewindex = AddItemEx(4,nRandSeed,0,tbItemBlueProp[1],tbItemBlueProp[2],tbItemBlueProp[3],nLevel,nSeries,nLuck,unpack(tbParam));
	
	local nGenreNew, nDetailTypeNew, nParticularNew, nLevelNew, nSeriesNew, nLuckNew = GetItemProp(itemnewindex);
	local tbParamNew = GetItemAllParams(itemnewindex);
	local strlognewitem = format("%d,%d,%d,%d,%d,%d",nGenreNew,nDetailTypeNew,nParticularNew,nLevelNew,nSeriesNew,nLuckNew)
	
	for k=1,getn(tbParamNew) do 
		strlognewitem = strlognewitem..format(",%d",tbParamNew[k])
	end
	Msg2SubWorld(GetName().." ®· chuyÓn ®æi thµnh c«ng vò khÝ: <color=cyan>"..itembluename.."<color> sang vò khÝ: <color=yellow>"..GetItemName(itemnewindex).."<color> ")
	--_Write2File("ChangeNewFormItemBlue_log",{format("%s Account: [%s] Nh©n VËt: [%s] ®· chuyÓn ®æi thµnh c«ng OldItemInfo: [%s] - NewItemInfo: [%s]",GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName(),strlogolditem,strlognewitem)})
end

function ITEMBLUE_MakeItemBlue()
	local tb = {"<dec><npc>§Ó chÕ t¹o ®­îc 1 trang bÞ xanh vip 6 dßng th× ng­¬i cÇn ph¶i cã 1 viªn thuû tinh. Tû lÖ x¸c xuÊt lµ 30%<enter><color=fire>1 viªn thuû tinh = 3 lÇn c¬ héi chÕ t¹o.<color><enter>HiÖn t¹i ng­¬i cã: "..gTask(ITEMBLUE_TSKID_COUNT).." lÇn chÕ t¹o."}
	tinsert(tb,"Ta muèn ®æi 3 lÇn chÕ t¹o [1 viªn thuû tinh]/ITEMBLUE_PayThuyTinh")
	tinsert(tb,"Ta muèn chÕ t¹o vò khÝ xanh/ITEMBLUE_GiveWeapon");
	tinsert(tb,"Ta muèn chÕ t¹o quÇn ¸o/ITEMBLUE_GiveClothes");
	tinsert(tb,"§Ó ta suy nghÜ thªm/cancel");
	CreateTaskSay(tb);
end

function cancel()
end

function ITEMBLUE_GiveClothes()
	if gTask(ITEMBLUE_TSKID_COUNT) > 0 then 
		newpl_laytrangbiquanao()
	else
		Talk(1,"","HiÖn t¹i ng­¬i sè lÇn chÕ t¹o cña ng­êi lµ: 0")
	end
end

function newpl_laytrangbiquanao()
	local tb = {};
	local list_do = {"¸o","Nãn","Bao Tay","Giaú","Ngäc Béi","NhÉn","D©y ChuyÒn","§ai L­ng"};
	local list_index = {{28,getn(tbQuanAo)},{12,25},{4,5},{8,11},{26,27},{3,3,},{1,2},{6,7}};
	for k=1,getn(list_do) do 
		tinsert(tb,{format("%s",list_do[k]),newpl_getdetailtype,{list_index[k][1],list_index[k][2]}});
	end
	
	tbDarkDescribe:SetNpcInfo("<#>H·y lùa chän ®å mµ ng­¬i muèn chÕ t¹o.",tb,10)
	tbDarkDescribe:DialogMenu(1)
end

function newpl_getdetailtype(nStart,nEnd)
	local tbOpt = {};
	--{zName = "Toµn Th¹ch Giíi ChØ ",		nProp = {0,3,0,10} },
	--tinsert(tbOpt,{format("%s",tbKiller[nBossLevel][k][1]),ShowBoss,{k,nBossLevel}});
	for k=nStart,nEnd do 
		tinsert(tbOpt,{format("%s",tbQuanAo[k].zName),getquanao_type,{k}});
	end
	
	tbDarkDescribe:SetNpcInfo("<#>H·y chän lo¹i trang bÞ quÇn ¸o mµ ng­¬i muèn chÕ t¹o.",tbOpt,10)
	tbDarkDescribe:DialogMenu(1)
end

function getquanao_type(index)
	if not GetRoomHanhTrang(1,4,4) then 
		return 
	end
	
	local tbOpt = {"<dec><npc>H·y lùa chän hÖ"};
	local series_ = {"Kim","Méc","Thuû","Ho¶","Thæ"};
	for k=1,getn(series_) do 
		tinsert(tbOpt,format("%s/#getquanao_series(%d,%d)",series_[k],index,(k-1)));
	end
	CreateTaskSay(tbOpt);
end


function getquanao_series(index,nseries)
	if not index or not nseries then 
		Say("Bug vui lßng b¸o cho gm",0);
		return 
	end
	SetLucky(1000000);
	local item = tbQuanAo[index].nProp
	local itemidx = AddVerItem(4,random(1000,2000),item[1],item[2],item[3],item[4],nseries,250,10)
	sTask(ITEMBLUE_TSKID_COUNT,gTask(ITEMBLUE_TSKID_COUNT) - 1)
	SetLucky(0);
	Msg2Player("B¹n nhËn ®­îc 1 trang bÞ xanh cÊp 10.")
end

function ITEMBLUE_GiveWeapon()
	if gTask(ITEMBLUE_TSKID_COUNT) > 0 then 
		newpl_layvukhi()
	else
		Talk(1,"","HiÖn t¹i ng­¬i sè lÇn chÕ t¹o cña ng­êi lµ: 0")
	end
end


function newpl_layvukhi()
	if not GetRoomHanhTrang(1,1,4) then 
		return 
	end
	
	local tb = {"<dec><npc>Ng­¬i muèn lÊy trang bÞ nµo?"}
	for k=1,getn(tbWeaponInfo) do 
		tinsert(tb,format("%s/#getweapon_type(%d)",tbWeaponInfo[k].szName,k));
	end
	CreateTaskSay(tb);
end

function getweapon_type(index)
	local tb = {"<dec><npc>H·y lùa chän hÖ cho trang bi."};
	local series_ = {"Kim","Méc","Thuû","Ho¶","Thæ"};
	for k=1,getn(series_) do 
		tinsert(tb,format("%s/#getweapon_done(%d,%d)",series_[k],(k-1),index));
	end
	CreateTaskSay(tb);
end

function getweapon_done(nseries,nindex)
	if not nseries or not nindex then 
		Say("bug vui lßng b¸o gm",0);
		return 
	end
	SetLucky(100);
	local p1,p2,p3,p4 = unpack(tbWeaponInfo[nindex].tbProp)
	local itemidx = AddVerItem(4,random(10000,20000),p1,p2,p3,p4,nseries,250,10)
	SetLucky(0);
	sTask(ITEMBLUE_TSKID_COUNT,gTask(ITEMBLUE_TSKID_COUNT) - 1)
	Msg2Player("B¹n nhËn ®­îc 1 trang bÞ vò khÝ xanh cÊp 10.")
end

function ITEMBLUE_PayThuyTinh()
	GiveItemUI("§æi Thuû Tinh Ra C¬ Héi ChÕ T¹o", "H·y §Æt Thuû Tinh Vµo", "ITEMBLUE_CheckThuyTinh", "cancel", 1);
end

function ITEMBLUE_CheckThuyTinh(nItemCount)
	local itempar = {[4] = {[238] = 1,[239] = 1,[240] = 1}};
	local tbremove = {};
	
	for k=1,nItemCount do 
		local itemidx = GetGiveItemUnit(k);
		local nPar,nID,nType = GetItemProp(itemidx);
		local myitemname = GetItemName(itemidx);
		if not itempar[nPar] then --ko ph¶i thuû tinh
			Say("B¹n ®· bá vµo 1 vËt phÈm kh«ng ph¶i thuû tinh.",0)
			return
		end
		
		if not itempar[nPar][nID] then 
			Say("B¹n ®· bá vµo 1 vËt phÈm kh«ng ph¶i thuû tinh.",0)
			return 
		end
		
		tinsert(tbremove,itemidx);
	end
	
	if getn(tbremove) > 0 then 
		local countdel = 0;
		for k=1,getn(tbremove) do 
			if (RemoveItemByIndex(tbremove[k]) ~= 1) then
				return
			end
			countdel = countdel + 1;
		end
		sTask(ITEMBLUE_TSKID_COUNT,countdel*3);
		Msg2Player("B¹n ®· ®æi ®­îc "..countdel.." viªn thuû tinh sang "..(countdel*3).." c¬ héi chÕ t¹o trang bÞ xanh.")
		--_Write2File("record_log/doithuytinh_cohoi",{format("%s Account: [%s] Nh©n vËt: [%s] ®· ®æi %d viªn thuû tinh sang %d c¬ héi.",GetLocalDate("%m/%d/%Y_%H:%M:%S"),GetAccount(),GetName(),countdel,countdel*3)})
	else
		Say("Ng­¬i kh«ng bá thuû tinh vµo lµm sao ta cã thÓ gióp ng­¬i??",0)
	end
end
