tbclass_newyear2008_zongbing = {}
tbclassname = tbclass_newyear2008_zongbing
tbclassname.TITLE = "B¸nh ch­ng"
tbclassname.LIMIT_LEVEL = 50
tbclassname.tbdate = {}
tbclassname.tbdate.nstart = 1803210000
tbclassname.tbdate.nend 	= 1805202400
tbclassname.mareial =
{
		nexpmax = 20000000000,
		ntask = 1872,
		tbitem = {
			{
				G=6,D=1,P=30196,szname="M¶nh chiÕn C«ng LÖnh 2",nexp=1000000,
				tbrandomitem =
				{
					ntotalprop = 100,
					tbitem = 
					{
						{G=6,D=1,P=4689,LV=1,szname="§å phæ Hoµng Kim ",prob=10},
						{G=6,D=1,P=4663,LV=1,szname="B¶o r­¬ng V« Danh ",prob=1},
						{G=6,D=1,P=2125,LV=1,szname="Ngò Hµnh Kú Th¹ch",prob=47},
						{G=0,D=11,P=201,LV=1,szname="MÆt n¹ - §Çu «ng ®Þa",prob=2 },
						{G=0,D=11,P=202,LV=1,szname="MÆt n¹ - Nam S­",prob=2 },
						{G=0,D=11,P=203,LV=1,szname="MÆt n¹ - B¾c S­",prob=2 },
						{G=0,D=11,P=204,LV=1,szname="MÆt n¹ - Long Ch©u",prob=2 },
						{G=0,D=11,P=205,LV=1,szname="MÆt n¹ - §Çu Rång",prob=2 },
						{G=0,D=11,P=206,LV=1,szname="MÆt n¹ - Th©n Rång",prob=2 },
						{G=0,D=11,P=207,LV=1,szname="MÆt n¹ - §u«i Rång",prob=2 },
						{G=6,D=1,P=4670,LV=1,szname="Thiªn V­¬ng Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4671,LV=1,szname="Ngò §éc Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4672,LV=1,szname="Thóy Yªn Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4673,LV=1,szname="C«n L«n Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4674,LV=1,szname="Thiªn NhÉn Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4675,LV=1,szname="ThiÕu L©m Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4676,LV=1,szname="§­êng M«n Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4677,LV=1,szname="Nga Mi Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4678,LV=1,szname="Vâ §ang Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},
						{G=6,D=1,P=4679,LV=1,szname="C¸i Bang Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 2 ",prob=1},					
--						{G=6,D=1,P=1480,LV=1,szname="Ng©n Bµi LÖnh"	 ,prob=5},
						{G=6,D=1,P=26,LV=1,szname="Vâ L©m MËt TÞch ",prob=0.5},
						{G=6,D=1,P=22,LV=1,szname="TÈy Tñy Kinh ",prob=0.5},
						{G=6,D=1,P=4692,LV=1,szname="Thiªn V­¬ng Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4693,LV=1,szname="Ngò §éc Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4694,LV=1,szname="Thóy Yªn Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4695,LV=1,szname="C«n L«n Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4696,LV=1,szname="Thiªn NhÉn Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4697,LV=1,szname="ThiÕu L©m Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4698,LV=1,szname="§­êng M«n Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4699,LV=1,szname="Nga Mi Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4700,LV=1,szname="Vâ §ang Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4701,LV=1,szname="C¸i Bang Hoµng Kim Trang BÞ B¶o R­¬ng Lo¹i 4 ",prob=1},
						{G=6,D=1,P=4702,LV=1,szname="Hoa S¬n Hoµng Kim Trang BÞ B¶o R­¬ng Néi C«ng ",prob=1},
						{G=6,D=1,P=4703,LV=1,szname="Hoa S¬n Hoµng Kim Trang BÞ B¶o R­¬ng Ngo¹i C«ng ",prob=1},					
					}
				} 
			},
			{G=6,D=1,P=30195,szname="M¶nh chiÕn C«ng LÖnh 1",nexp=500000,
				tbrandomitem =
				{
					ntotalprop = 100,
					tbitem = 
					{
						{G=6,D=1,P=4689,LV=1,szname="§å phæ Hoµng Kim ",prob=5},
						{G=6,D=1,P=2125,LV=1,szname="Ngò Hµnh Kú Th¹ch",prob=73},
						{G=0,D=11,P=201,LV=1,szname="MÆt n¹ - §Çu «ng ®Þa",prob=3 },
						{G=0,D=11,P=202,LV=1,szname="MÆt n¹ - Nam S­",prob=3 },
						{G=0,D=11,P=203,LV=1,szname="MÆt n¹ - B¾c S­",prob=3 },
						{G=0,D=11,P=204,LV=1,szname="MÆt n¹ - Long Ch©u",prob=3 },
						{G=0,D=11,P=205,LV=1,szname="MÆt n¹ - §Çu Rång",prob=3 },
						{G=0,D=11,P=206,LV=1,szname="MÆt n¹ - Th©n Rång",prob=3 },
						{G=0,D=11,P=207,LV=1,szname="MÆt n¹ - §u«i Rång",prob=3 },
						{G=6,D=1,P=26,LV=1,szname="Vâ L©m MËt TÞch ",prob=0.5},
						{G=6,D=1,P=22,LV=1,szname="TÈy Tñy Kinh ",prob=0.5},							
					}
				}
			},
			{G=6,D=1,P=1664,szname="B¸nh ch­ng th­êng",nexp=500000},
		},	
}

function main(sel)
	
	local prop = tbclassname:pack(GetItemProp(sel))
	local szkey = format("%s,%s,%s",prop[1],prop[2],prop[3])
	local tbitem = tbclassname:selectitem(szkey)
	if tbitem == nil then
		Say("VËt phÈm sai, xin liªn hÖ víi ng­êi qu¶n lý.",0)
		return 1
	end
	if tbclassname:check() == 0 then
		return 1
	elseif tbclassname:check() == 2 then
		return 0
	end
	tbclassname:useitem(tbitem.nexp)
	if tbitem.tbrandomitem ~= nil then
		tbclassname:getradomitem(tbitem.tbrandomitem)
	end
end
function tbclassname:getradomitem(tbitem)
	local tbclass = tbitem
	local p = random(1,(tbclass.ntotalprop*100))
	local nsum = 0
	for ni,nitem in tbclass.tbitem do
				nsum = nsum + (nitem.prob*tbclass.ntotalprop)
				if nsum >= p then
					AddItem(nitem.G,nitem.D,nitem.P,nitem.LV,0,0)
					local szstr = format("Chóc mõng b¹n nhËn ®­îc 1 <color=yellow>%s<color>",nitem.szname)
					Msg2Player(szstr)
					self:sdl_writelog(self.TITLE,szstr)
					return
				end
	end	
end
function tbclassname:useitem(naddexp)
	local nexp = GetTask(self.mareial.ntask)
	local nexpn = naddexp
	if nexp + naddexp > self.mareial.nexpmax then
		nexpn = self.mareial.nexpmax - nexp
	end
	local szstr = format("Chóc mõng b¹n nhËn ®­îc <color=yellow>%s<color> kinh nghiÖm.",nexpn)
	AddOwnExp(nexpn)
	SetTask(self.mareial.ntask,nexp+nexpn)
	Msg2Player(szstr)
	self:sdl_writelog(self.TITLE,szstr)
end
function tbclassname:selectitem(szkey)
	for ni,nitem in self.mareial.tbitem do
		local szitemkey = format("%s,%s,%s",nitem.G,nitem.D,nitem.P)
		if szitemkey == szkey then
			return nitem
		end
	end
	return nil
end
function tbclassname:check()
	if self:check_date() == 0 then
		Say("B¸nh ch­ng ®· qu¸ h¹n, kh«ng thÓ sö dông.",0)
		return 2
	end
	if self:check_level() == 0 then
		Say("§¼ng cÊp ch­a ®¹t 50 kh«ng thÓ thùc dông.",0)
		return 0
	end
	if self:check_pay() == 0 then
		Say("B¹n vÉn ch­a n¹p thÎ, kh«ng thÓ sö dông.",0)
		return 0
	end
	if self:check_exp() == 0 then
		Say("Ho¹t ®éng lµm b¸nh ch­ng, b¹n ®· ®¹t ®iÓm kinh nghiÖm tèi ®a, kh«ng thÓ sö dông n÷a.",0)
		return 0
	end
	if CalcFreeItemCellCount() < 1 then
		Say("Kh«ng ®ñ chç trèng, h·y s¾p xÕp l¹i hµnh trang.",0)
		return 0
	end
	return 1
end

function tbclassname:pack(...) --×ª³Étable
	return arg
end

function tbclassname:check_exp()
	local nexp = GetTask(self.mareial.ntask)
	if nexp >= self.mareial.nexpmax then
		return 0
	end
	return 1
end
function tbclassname:check_date()--ÅÐ¶ÏÊ±¼ä
	local ndate = tonumber(GetLocalDate("%y%m%d%H%M"))
	if ndate >= self.tbdate.nstart and ndate <= self.tbdate.nend then
		return 1
	end
	return 0
end

function tbclassname:check_level()		--ÅÐ¶ÏµÈ¼¶
	if GetLevel() < tbclassname.LIMIT_LEVEL then
		return 0
	end 
	return 1
end

function tbclassname:check_pay()		--ÅÐ¶Ï³äÖµÓÃ»§
	if GetExtPoint(0) <= 0 then
		return 0
	end 
	return 1
end

function tbclassname:sdl_writelog(sztitle,szevent)	--¼ÇÂ¼,sztitle=ÊÂ¼þÃû,szevent=ÊÂ¼þÄÚÈÝ
	WriteLog(format("[%s]\t Date:%s\t Account:%s\t Name:%s\t %s",sztitle,GetLocalDate("%y-%m-%d %H:%M:%S"),GetAccount(),GetName(),szevent));
end